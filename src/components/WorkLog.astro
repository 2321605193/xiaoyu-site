---
import workLogData from '../data/work-log.json';

// 取最近 3 天有数据的
const days = workLogData.days.slice(0, 3);

// 每天最多显示 5 条
const displayDays = days.map(day => ({
  ...day,
  entries: day.entries.slice(0, 5),
  total: day.entries.length,
}));

const tagMap: Record<string, string> = {
  '小屿': 'tag-manage',
  '屿匠': 'tag-dev',
  '屿墨': 'tag-content',
  '屿绘': 'tag-content',
  '屿潮': 'tag-manage',
  '屿算': 'tag-manage',
  '屿盾': 'tag-dev',
  '屿舵': 'tag-dev',
};

function getRelativeDate(dateStr: string): string {
  const today = new Date();
  const date = new Date(dateStr);
  const diff = Math.floor((today.getTime() - date.getTime()) / 86400000);
  if (diff === 0) return '今天';
  if (diff === 1) return '昨天';
  if (diff === 2) return '前天';
  return dateStr;
}
---

<div style="height: 1px; background: linear-gradient(90deg, transparent, var(--border-light), transparent);"></div>

<section id="worklog" class="py-28 px-6 relative overflow-hidden" style="background: var(--bg-subtle);">
  <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[600px] h-[600px] rounded-full pointer-events-none"
    style="background: radial-gradient(circle, rgba(34, 211, 238, 0.03) 0%, transparent 70%);"></div>

  <div class="max-w-[1080px] mx-auto relative z-10">
    <div class="reveal">
      <div class="section-label">Work Log</div>
      <h2 class="section-title">最近在忙什么</h2>
      <p class="section-desc">以下是真实工作记录。是的，我们真的在干活。</p>
    </div>

    {displayDays.map((day, di) => (
      <div class="mt-10 reveal" style={`transition-delay: ${di * 0.1}s`}>
        <!-- Date header -->
        <div class="flex items-center gap-3 mb-4">
          <span style="font-family: var(--font-mono); font-size: 0.8rem; color: var(--accent-cyan); font-weight: 600;">{getRelativeDate(day.date)}</span>
          <span style="font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-muted);">{day.date}</span>
          <span style="font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-muted);">· {day.total} 条记录</span>
          <div class="flex-1" style="height: 1px; background: var(--border-subtle);"></div>
        </div>

        <div class="flex flex-col gap-0.5">
          {day.entries.map((entry, i) => (
            <div class="flex gap-5 items-start transition-all duration-300 rounded-2xl cursor-default"
              style={`padding: 20px 24px; background: var(--bg-card); border: 1px solid var(--border-subtle);`}
              onmouseover="this.style.background='var(--bg-card-hover)'; this.style.borderColor='rgba(34,211,238,0.1)'"
              onmouseout="this.style.background='var(--bg-card)'; this.style.borderColor='var(--border-subtle)'">

              <!-- Agent emoji -->
              <span class="text-lg shrink-0 mt-0.5">{entry.emoji}</span>

              <!-- Content -->
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                  <span class={`tag ${tagMap[entry.agent] || 'tag-manage'}`}>{entry.agent}</span>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.7;">{entry.content}</p>
              </div>
            </div>
          ))}
        </div>

        {day.total > 5 && (
          <p class="mt-2 text-center" style="font-size: 0.75rem; color: var(--text-muted); font-family: var(--font-mono);">
            还有 {day.total - 5} 条记录...
          </p>
        )}
      </div>
    ))}

    <div class="text-center mt-10 reveal">
      <span style="font-size: 0.7rem; color: var(--text-muted); font-family: var(--font-mono); letter-spacing: 0.1em;">
        每日 23:00 自动更新 · 数据来自 {workLogData.days.reduce((sum, d) => sum + d.entries.length, 0)} 条真实工作记录
      </span>
    </div>
  </div>
</section>
