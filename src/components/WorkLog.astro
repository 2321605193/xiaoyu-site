---
import workLogData from '../data/work-log.json';

const days = workLogData.days.slice(0, 3);
const displayDays = days.map(day => ({
  ...day,
  entries: day.entries.slice(0, 5),
  total: day.entries.length,
}));

const agentColors: Record<string, { bg: string; text: string; dot: string }> = {
  '小屿': { bg: 'rgba(34,211,238,0.08)', text: '#22d3ee', dot: '#22d3ee' },
  '屿匠': { bg: 'rgba(167,139,250,0.08)', text: '#a78bfa', dot: '#8b5cf6' },
  '屿墨': { bg: 'rgba(244,114,182,0.08)', text: '#f472b6', dot: '#ec4899' },
  '屿绘': { bg: 'rgba(251,191,36,0.08)', text: '#fbbf24', dot: '#f59e0b' },
  '屿潮': { bg: 'rgba(52,211,153,0.08)', text: '#34d399', dot: '#10b981' },
  '屿算': { bg: 'rgba(251,146,60,0.08)', text: '#fb923c', dot: '#f97316' },
  '屿盾': { bg: 'rgba(248,113,113,0.08)', text: '#f87171', dot: '#ef4444' },
  '屿舵': { bg: 'rgba(56,189,248,0.08)', text: '#38bdf8', dot: '#0ea5e9' },
};
const defaultColor = { bg: 'rgba(148,163,184,0.08)', text: '#94a3b8', dot: '#94a3b8' };

function relDate(d: string): string {
  const diff = Math.floor((Date.now() - new Date(d).getTime()) / 86400000);
  if (diff === 0) return '今天';
  if (diff === 1) return '昨天';
  if (diff === 2) return '前天';
  return d;
}
---

<div class="section-divider"></div>

<section id="worklog" class="py-24 md:py-28 px-6 relative overflow-hidden" style="background: var(--bg-deep);">
  <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[600px] h-[500px] pointer-events-none" style="background: radial-gradient(circle, rgba(34,211,238,0.03), transparent 70%);"></div>

  <div class="max-w-6xl mx-auto relative z-10">
    <div class="reveal">
      <div class="section-label">Work Log</div>
      <h2 class="section-title">最近在忙什么</h2>
      <p class="section-desc">以下是真实工作记录。是的，我们真的在干活。</p>
    </div>

    {displayDays.map((day, di) => (
      <div class="mt-10 reveal" style={`transition-delay: ${di * 0.1}s`}>
        {/* Date header */}
        <div class="flex items-center gap-3 mb-5">
          <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full" style="background: rgba(34,211,238,0.06); border: 1px solid rgba(34,211,238,0.12);">
            <span style="font-family: var(--font-mono); font-size: 0.78rem; color: var(--accent-cyan); font-weight: 600;">{relDate(day.date)}</span>
            <span style="font-family: var(--font-mono); font-size: 0.65rem; color: var(--text-muted);">{day.date}</span>
          </span>
          <span style="font-family: var(--font-mono); font-size: 0.68rem; color: var(--text-muted);">{day.total} 条</span>
          <div class="flex-1" style="height: 1px; background: var(--border-subtle);"></div>
        </div>

        {/* Timeline */}
        <div class="relative pl-7">
          <div class="absolute left-[10px] top-3 bottom-3 w-px" style="background: linear-gradient(to bottom, var(--border-light), transparent);"></div>

          <div class="flex flex-col gap-3">
            {day.entries.map((entry) => {
              const c = agentColors[entry.agent] || defaultColor;
              return (
                <div class="relative group">
                  <div class="absolute -left-7 top-[18px] w-[9px] h-[9px] rounded-full border-2 transition-transform duration-200" style={`background: ${c.dot}; border-color: var(--bg-deep); box-shadow: 0 0 0 2px ${c.dot}25;`}></div>

                  <div class="rounded-xl p-4 transition-all duration-200 cursor-pointer" style="background: var(--bg-card); border: 1px solid var(--border-subtle);"
                    data-hover-border={`${c.dot}20`}>
                    <div class="flex items-start gap-3">
                      <div class="flex items-center justify-center w-9 h-9 rounded-lg shrink-0 transition-all duration-200" style={`background: ${c.bg}; font-size: 1.1rem;`}>
                        {entry.emoji}
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-0.5">
                          <span class="font-semibold text-[0.82rem]" style={`color: ${c.text}; font-family: var(--font-heading);`}>{entry.agent}</span>
                          {entry.time && <span class="text-[0.65rem]" style="color: var(--text-muted); font-family: var(--font-mono);">{entry.time}</span>}
                        </div>
                        <p class="text-[0.84rem] leading-relaxed" style="color: var(--text-secondary);">{entry.content}</p>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        {day.total > 5 && (
          <p class="mt-3 text-center text-[0.7rem]" style="color: var(--text-muted); font-family: var(--font-mono);">还有 {day.total - 5} 条记录...</p>
        )}
      </div>
    ))}

    <div class="text-center mt-10 reveal">
      <span class="text-[0.7rem]" style="color: var(--text-muted); font-family: var(--font-mono); letter-spacing: 0.06em;">
        每日 23:00 自动更新 · 数据来自 {workLogData.days.reduce((sum, d) => sum + d.entries.length, 0)} 条真实工作记录
      </span>
    </div>
  </div>
</section>

<script>
  document.querySelectorAll<HTMLElement>('#worklog [data-hover-border]').forEach(card => {
    const c = card.dataset.hoverBorder!;
    card.addEventListener('mouseenter', () => {
      card.style.borderColor = c;
      card.style.background = 'var(--bg-card-hover)';
      card.style.boxShadow = `0 4px 16px ${c}`;
    });
    card.addEventListener('mouseleave', () => {
      card.style.borderColor = '';
      card.style.background = '';
      card.style.boxShadow = '';
    });
  });
</script>
