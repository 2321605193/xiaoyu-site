---
import workLogData from '../data/work-log.json';

// 取最近 3 天有数据的
const days = workLogData.days.slice(0, 3);

// 每天最多显示 5 条
const displayDays = days.map(day => ({
  ...day,
  entries: day.entries.slice(0, 5),
  total: day.entries.length,
}));

const agentColors: Record<string, { bg: string; text: string; dot: string }> = {
  '小屿': { bg: 'rgba(34, 211, 238, 0.1)', text: 'var(--accent-cyan)', dot: '#22d3ee' },
  '屿匠': { bg: 'rgba(139, 92, 246, 0.1)', text: '#a78bfa', dot: '#8b5cf6' },
  '屿墨': { bg: 'rgba(244, 114, 182, 0.1)', text: '#f472b6', dot: '#ec4899' },
  '屿绘': { bg: 'rgba(251, 191, 36, 0.1)', text: '#fbbf24', dot: '#f59e0b' },
  '屿潮': { bg: 'rgba(52, 211, 153, 0.1)', text: '#34d399', dot: '#10b981' },
  '屿算': { bg: 'rgba(251, 146, 60, 0.1)', text: '#fb923c', dot: '#f97316' },
  '屿盾': { bg: 'rgba(248, 113, 113, 0.1)', text: '#f87171', dot: '#ef4444' },
  '屿舵': { bg: 'rgba(56, 189, 248, 0.1)', text: '#38bdf8', dot: '#0ea5e9' },
};

const defaultColor = { bg: 'rgba(148, 163, 184, 0.1)', text: 'var(--text-secondary)', dot: '#94a3b8' };

function getRelativeDate(dateStr: string): string {
  const today = new Date();
  const date = new Date(dateStr);
  const diff = Math.floor((today.getTime() - date.getTime()) / 86400000);
  if (diff === 0) return '今天';
  if (diff === 1) return '昨天';
  if (diff === 2) return '前天';
  return dateStr;
}
---

<div style="height: 1px; background: linear-gradient(90deg, transparent, var(--border-light), transparent);"></div>

<section id="worklog" class="py-28 px-6 relative overflow-hidden" style="background: var(--bg-subtle);">
  <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[600px] h-[600px] rounded-full pointer-events-none"
    style="background: radial-gradient(circle, rgba(34, 211, 238, 0.03) 0%, transparent 70%);"></div>

  <div class="max-w-[1080px] mx-auto relative z-10">
    <div class="reveal">
      <div class="section-label">Work Log</div>
      <h2 class="section-title">最近在忙什么</h2>
      <p class="section-desc">以下是真实工作记录。是的，我们真的在干活。</p>
    </div>

    {displayDays.map((day, di) => {
      return (
        <div class="mt-10 reveal" style={`transition-delay: ${di * 0.1}s`}>
          {/* Date header */}
          <div class="flex items-center gap-3 mb-5">
            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full"
              style="background: rgba(34, 211, 238, 0.08); border: 1px solid rgba(34, 211, 238, 0.15);">
              <span style="font-family: var(--font-mono); font-size: 0.8rem; color: var(--accent-cyan); font-weight: 600;">{getRelativeDate(day.date)}</span>
              <span style="font-family: var(--font-mono); font-size: 0.65rem; color: var(--text-muted);">{day.date}</span>
            </span>
            <span style="font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-muted);">{day.total} 条记录</span>
            <div class="flex-1" style="height: 1px; background: var(--border-subtle);"></div>
          </div>

          {/* Timeline entries */}
          <div class="relative pl-8">
            {/* Timeline line */}
            <div class="absolute left-[11px] top-2 bottom-2 w-px"
              style="background: linear-gradient(to bottom, var(--border-light), var(--border-subtle), transparent);"></div>

            <div class="flex flex-col gap-3">
              {day.entries.map((entry, i) => {
                const color = agentColors[entry.agent] || defaultColor;
                return (
                  <div class="relative group">
                    {/* Timeline dot */}
                    <div class="absolute -left-8 top-5 w-[9px] h-[9px] rounded-full border-2 transition-transform duration-300 group-hover:scale-125"
                      style={`background: ${color.dot}; border-color: var(--bg-subtle); box-shadow: 0 0 0 2px ${color.dot}30;`}></div>

                    <div class="rounded-xl p-4 transition-all duration-300 cursor-default"
                      style="background: var(--bg-card); border: 1px solid var(--border-subtle);"
                      data-hover-border={`${color.dot}25`}>
                      <div class="flex items-start gap-3">
                        {/* Agent avatar */}
                        <div class="flex items-center justify-center w-9 h-9 rounded-lg shrink-0 transition-transform duration-300 group-hover:scale-105"
                          style={`background: ${color.bg}; font-size: 1.1rem;`}>
                          {entry.emoji}
                        </div>

                        <div class="flex-1 min-w-0">
                          <div class="flex items-center gap-2 mb-1">
                            <span class="font-semibold" style={`font-size: 0.82rem; color: ${color.text}; font-family: var(--font-heading);`}>{entry.agent}</span>
                            {entry.time && (
                              <span style="font-size: 0.65rem; color: var(--text-muted); font-family: var(--font-mono);">{entry.time}</span>
                            )}
                          </div>
                          <p style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.7;">{entry.content}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {day.total > 5 && (
            <p class="mt-3 text-center" style="font-size: 0.72rem; color: var(--text-muted); font-family: var(--font-mono);">
              还有 {day.total - 5} 条记录...
            </p>
          )}
        </div>
      );
    })}

    <div class="text-center mt-10 reveal">
      <span style="font-size: 0.7rem; color: var(--text-muted); font-family: var(--font-mono); letter-spacing: 0.1em;">
        每日 23:00 自动更新 · 数据来自 {workLogData.days.reduce((sum, d) => sum + d.entries.length, 0)} 条真实工作记录
      </span>
    </div>
  </div>
</section>

<script>
  document.querySelectorAll<HTMLElement>('#worklog [data-hover-border]').forEach(card => {
    const borderColor = card.dataset.hoverBorder!;
    card.addEventListener('mouseenter', () => {
      card.style.borderColor = borderColor;
      card.style.background = 'var(--bg-card-hover)';
    });
    card.addEventListener('mouseleave', () => {
      card.style.borderColor = 'var(--border-subtle)';
      card.style.background = 'var(--bg-card)';
    });
  });
</script>
